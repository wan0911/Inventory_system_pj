CREATE DATABASE materialdb;

/* ---- 자재정보 테이블 ---- */
CREATE TABLE materials_info
(MATERIAL_CODE varchar(100) PRIMARY KEY, 
MATERIAL_NAME varchar(100), 
MATERIAL_GROUP varchar(40), 
USE_FLAG varchar(40), 
CRT_DT datetime, 
UDT_DT datetime);


INSERT INTO materials_info 
VALUES 
('A00', 'BATTERY_01', '배터리', 'Y', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
('A01', 'BATTERY_02', '배터리', 'Y', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
('A02', 'LED_PANEL', '디스플레이', 'N', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP);

INSERT INTO materials_info 
VALUES 
('B00', 'LED_PANEL', '디스플레이', 'N', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP);

SELECT * FROM materials_info;

UPDATE materials_info
SET MATERIAL_CODE = 'B00'
WHERE MATERIAL_CODE = 'A02'


/* ---- 공통코드 테이블 ---- */
CREATE TABLE com_code
(CODE_ID varchar(10) PRIMARY KEY,
CODE_NAME varchar(100) NOT NULL, 
USE_FLAG  varchar(1) NOT NULL, 
CRT_DT datetime NOT NULL, 
UDT_DT datetime);


INSERT INTO com_code(CODE_ID, CODE_NAME, USE_FLAG, CRT_DT) VALUES 
('A', '배터리', 'Y', CURRENT_TIMESTAMP),
('B', '디스플레이', 'N', CURRENT_TIMESTAMP);
INSERT INTO com_code(CODE_ID, CODE_NAME, USE_FLAG, CRT_DT) VALUES 
('C', '케이스', 'N', CURRENT_TIMESTAMP);

SELECT * FROM com_code;





/* ---- 공통코드아이템 테이블 ---- */
CREATE TABLE com_code_item
(CODE_ID varchar(10),
CODE_ITEM_ID varchar(100), 
CODE_ITEM_NAME varchar(10) NOT NULL,
USE_FLAG  varchar(1) NOT NULL, 
CRT_DT datetime NOT NULL, 
UDT_DT datetime);

-- 외래키 제약 조건 
-- 1. CODE_ITEM_ID
ALTER TABLE com_code_item
ADD CONSTRAINT CODE_ITEM_ID
FOREIGN KEY (CODE_ITEM_ID) REFERENCES materials_info(MATERIAL_CODE)
ON DELETE CASCADE
ON UPDATE CASCADE

-- 2. CODE_ID
ALTER TABLE com_code_item
ADD CONSTRAINT CODE_ID
FOREIGN KEY (CODE_ID) REFERENCES com_code(CODE_ID)
ON DELETE CASCADE
ON UPDATE CASCADE

INSERT INTO com_code_item (CODE_ID, CODE_ITEM_ID, CODE_ITEM_NAME, USE_FLAG, CRT_DT, UDT_DT)
VALUES
  ('A', 'A00', 'BATTERY_01', 'Y', GETDATE(), NULL),
  ('A', 'A01', 'BATTERY_02', 'Y', GETDATE(), NULL),
  ('B', 'B00', 'LED_PANEL', 'Y', GETDATE(), NULL),
  ('C', 'C00', 'CASE_01', 'N', GETDATE(), NULL)

INSERT INTO com_code_item (CODE_ID, CODE_ITEM_ID, CODE_ITEM_NAME, USE_FLAG, CRT_DT, UDT_DT)
VALUES
  ('B', 'B00', 'LED_PANEL', 'Y', GETDATE(), NULL)

SELECT * FROM com_code_item;





---- db 쿼리 ---- 
INSERT INTO com_code_item (CODE_ID, CODE_ITEM_ID, CODE_ITEM_NAME, USE_FLAG, CRT_DT, UDT_DT)
VALUES
  ('A', 'A02', 'BATTERY_02', 'Y', GETDATE(), NULL)


-- com_code_item 테이블 확인
SELECT * FROM com_code_item;





SELECT MATERIAL.MATERIAL_CODE, MATERIAL.MATERIAL_NAME, CODE.CODE_NAME, CODE_ITEM.USE_FLAG, FORMAT(MATERIAL.CRT_DT, 'MM-dd') AS CRT_DT, FORMAT(MATERIAL.UDT_DT,'MM-dd') AS UDT_DT
FROM dbo.TB_COM_MATERIAL AS MATERIAL INNER JOIN dbo.TB_COM_CODE_ITEM AS CODE_ITEM
"ON MATERIAL.MATERIAL_CODE = CODE_ITEM.CODE_ITEM_ID " +
"INNER JOIN dbo.TB_COM_CODE AS CODE " +
"ON CODE.CODE_ID = CODE_ITEM.CODE_ID "



SELECT MI.MATERIAL_CODE, MI.MATERIAL_NAME, CC.CODE_NAME, CCI.USE_FLAG, MI.CRT_DT, MI.UDT_DT
FROM materials_info AS MI 
INNER JOIN com_code_item AS CCI 
ON MI.MATERIAL_CODE = CCI.CODE_ITEM_ID
INNER JOIN COM_CODE AS CC
ON CC.CODE_ID = CCI.CODE_ID
AND MI.MATERIAL_CODE = 'A00'
AND MI.MATERIAL_NAME = ''
AND CC.CODE_NAME = ''
AND CCI.USE_FLAG = ''


SELECT MI.MATERIAL_CODE, MI.MATERIAL_NAME, CC.CODE_NAME, CCI.USE_FLAG, MI.CRT_DT, MI.UDT_DT
FROM materials_info AS MI
INNER JOIN com_code_item AS CCI ON MI.MATERIAL_CODE = CCI.CODE_ITEM_ID
INNER JOIN com_code AS CC ON CC.CODE_ID = CCI.CODE_ID
WHERE 1=1 AND MI.MATERIAL_CODE = 'A01' AND CC.CODE_NAME = '케이스'


SELECT * FROM com_code_item;
SELECT * FROM com_code
SELECT * FROM materials_info;




-- 테이블 데이터 삭제
TRUNCATE TABLE materials_info